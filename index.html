<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mines MVP 5.0 Casino</title>
<style>
body { font-family:sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; margin:0; padding:0; height:100vh;
       background: radial-gradient(circle at top, #111, #000); color:white; }
h1 { margin-top:20px; text-shadow: 2px 2px 5px #000; }
#balance { margin:10px; font-size:22px; transition: color 0.3s; }
#status { margin-top:10px; font-size:18px; min-height:24px; text-align:center; }
#bet-container { margin:15px; }
button { padding:8px 16px; margin:5px; cursor:pointer; border:none; border-radius:5px; background:#FFD700; color:#222; font-weight:bold; box-shadow: 0 4px 6px rgba(0,0,0,0.4); transition: transform 0.2s; }
button:hover { transform: translateY(-3px); box-shadow: 0 6px 8px rgba(0,0,0,0.6); }

table { border-collapse:collapse; margin:auto; }
td { width:70px; height:70px; text-align:center; vertical-align:middle; border-radius:8px; border:1px solid #444; font-weight:bold; cursor:pointer;
     background: linear-gradient(to bottom, #444, #111); box-shadow: 0 4px 6px rgba(0,0,0,0.6); transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease; }
td.flipped { transform: rotateY(180deg); }
td.safe { background: linear-gradient(to bottom, #4CAF50, #2E7D32); color:white; box-shadow: 0 0 20px #4CAF50; animation: pulse 0.6s infinite alternate; }
td.bomb { background: linear-gradient(to bottom, #f44336, #b71c1c); color:white; animation: shake 0.5s; box-shadow: 0 0 20px #f44336; }

@keyframes shake { 0%{transform:translateX(0);}25%{transform:translateX(-5px);}50%{transform:translateX(5px);}75%{transform:translateX(-5px);}100%{transform:translateX(0);} }
@keyframes pulse { 0%{box-shadow:0 0 10px #4CAF50;} 100%{box-shadow:0 0 25px #4CAF50;} }

#multibar-container { width:360px; height:20px; background:#222; border:1px solid #555; margin-bottom:10px; border-radius:10px; }
#multibar { height:100%; width:0%; background:#FFD700; border-radius:10px; transition: width 0.3s; }
</style>
</head>
<body>

<h1>Mines MVP 5.0 Casino</h1>
<div id="balance">Balance: ...</div>

<div id="multibar-container">
  <div id="multibar"></div>
</div>

<div id="bet-container">
Bet: <input type="number" id="bet" value="10" min="1" max="100">
Bombs: <input type="number" id="bombs" value="5" min="1" max="15">
<button id="startBtn">Start Game</button>
<button id="cashoutBtn">Cashout</button>
</div>

<table id="grid"></table>
<div id="status"></div>

<script>
let userId = "guest1";
let currentGame = false;

const balanceEl = document.getElementById("balance");
const startBtn = document.getElementById("startBtn");
const cashoutBtn = document.getElementById("cashoutBtn");
const gridEl = document.getElementById("grid");
const statusEl = document.getElementById("status");
const multibar = document.getElementById("multibar");

async function loadBalance(){
  const res = await fetch(`/api/balance/${userId}`);
  const data = await res.json();
  updateBalance(data.balance);
}

function updateBalance(bal){ balanceEl.innerText = "Balance: " + bal.toFixed(2); }
function updateStatus(msg){ statusEl.innerText = msg; }
function updateMultiplierBar(mult){ const width = Math.min(mult*10,100); multibar.style.width = width+"%"; }

function createGrid(){
  gridEl.innerHTML = "";
  for(let i=0;i<5;i++){
    const row = document.createElement("tr");
    for(let j=0;j<5;j++){
      const cell = document.createElement("td");
      cell.onclick = ()=>openTile(i,j,cell);
      row.appendChild(cell);
    }
    gridEl.appendChild(row);
  }
  updateStatus("");
  updateMultiplierBar(1);
}

startBtn.onclick = async ()=>{
  if(currentGame){ alert("Finish current game first!"); return; }
  const bet = parseFloat(document.getElementById("bet").value);
  const bombs = parseInt(document.getElementById("bombs").value);

  const res = await fetch("/api/start",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({userId,bet,bombs}) });
  const data = await res.json();
  if(data.error){ alert(data.error); return; }

  currentGame = true;
  createGrid();
  updateBalance(data.balance);
}

async function openTile(row,col,cell){
  if(!currentGame) return;
  const res = await fetch("/api/open",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({userId,row,col}) });
  const data = await res.json();
  if(data.error){ alert(data.error); return; }

  cell.classList.add("flipped");

  if(data.result==="bomb"){
    setTimeout(()=>{ cell.classList.add("bomb"); },150);
    updateStatus(`ðŸ’¥ Game Over! Multiplier: ${data.multiplier.toFixed(2)}x`);
    currentGame=false;
  } else if(data.result==="safe"){
    setTimeout(()=>{ cell.classList.add("safe"); },150);
    updateStatus(`Multiplier: ${data.multiplier.toFixed(2)}x | Profit: ${data.profit.toFixed(2)}`);
    updateMultiplierBar(data.multiplier);
  }
}

cashoutBtn.onclick = async ()=>{
  if(!currentGame){ alert("No active game"); return; }
  const res = await fetch("/api/cashout",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({userId}) });
  const data = await res.json();
  updateBalance(data.balance);
  updateStatus("ðŸŽ‰ Cashed out!");
  currentGame=false;
  updateMultiplierBar(1);
}

loadBalance();
createGrid();
</script>

</body>
</html>
